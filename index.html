<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Medlemssida</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 24px; background:#f5f5f5; }
    .box { max-width: 520px; margin: 40px auto; padding: 18px; background:#fff; border:1px solid #ddd; border-radius: 10px; text-align:center; }
    input, button { font-size: 16px; padding: 10px 12px; margin: 6px 4px; }
    button { cursor:pointer; }
    #msg { min-height: 1.5em; }
  </style>

  <!-- Turnstile script -->
  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
</head>
<body>
  <div class="box">
    <h1>Medlemsinlogg</h1>
    <p>Ange medlemsnummer, f√∂rnamn och e-post (f√∂rnamn/e-post kan skrivas i valfri text; vi normaliserar i servern).</p>
    <div>
      <input id="memberNumber" placeholder="Medlemsnummer">
      <input id="firstName" placeholder="F√∂rnamn">
      <input id="email" placeholder="E-post">
    </div>

    <!-- Turnstile-widget (din site key) -->
    <div class="cf-turnstile"
         data-sitekey="0x4AAAAAABrjb_SBoAoT0t2O"
         data-callback="onTurnstile"
         data-expired-callback="onTurnstileExpired"></div>

    <button id="loginBtn">Logga in</button>
    <p id="msg"></p>
  </div>

<script>
  // üîó Din Worker-endpoint:
  const API = 'https://crimson-darkness-35c2.k-e-cederlund.workers.dev/api/login';

  // Turnstile token hantering
  let tsToken = '';
  function onTurnstile(token) { tsToken = token || ''; }
  function onTurnstileExpired() { tsToken = ''; }

  document.getElementById('loginBtn').addEventListener('click', submitLogin);

  async function submitLogin() {
    const memberNumber = document.getElementById('memberNumber').value.trim();
    const firstName    = document.getElementById('firstName').value.trim();
    const email        = document.getElementById('email').value.trim();
    const msg          = document.getElementById('msg');

    if (!memberNumber || !firstName || !email) {
      msg.textContent = 'Fyll i alla tre f√§lten.';
      return;
    }
    if (!tsToken) {
      msg.textContent = 'Bekr√§fta robotkontrollen f√∂rst.';
      return;
    }

    msg.textContent = 'Kontrollerar...';

    try {
      const res = await fetch(API, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ memberNumber, firstName, email, turnstileToken: tsToken }),
        mode: 'cors',
        credentials: 'include'
      });
      const data = await res.json().catch(()=>({}));

      if (res.status === 200 && data.ok && data.start) {
        // ‚úÖ Session-l√•s: navigera till /start?c=... s√• s√§tts cookie i f√∂rstaparts-kontekst
        window.location.href = data.start;
      } else if (res.status === 403 && data.reason === 'not_yet') {
        const ms = (data.releaseAt || 0) - Date.now();
        const m = Math.max(0, Math.floor(ms/60000));
        const s = Math.max(0, Math.floor((ms%60000)/1000));
        msg.textContent = `Biljettl√§nken blir tillg√§nglig om ${m} min ${s} s.`;
      } else if (res.status === 401) {
        msg.textContent = 'Fel uppgifter. F√∂rs√∂k igen.';
      } else if (res.status === 400 && data.reason === 'turnstile_required') {
        msg.textContent = 'Bekr√§fta robotkontrollen f√∂rst.';
      } else if (res.status === 403 && data.reason === 'bot_detected') {
        msg.textContent = 'Robotkontrollen misslyckades. Ladda om sidan och f√∂rs√∂k igen.';
      } else {
        msg.textContent = 'Tekniskt fel. F√∂rs√∂k igen strax.';
      }
    } catch (e) {
      msg.textContent = 'N√§tverksfel. F√∂rs√∂k igen.';
    }
  }
</script>
</body>
</html>
